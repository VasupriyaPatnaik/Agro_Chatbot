<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AgroBot Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: linear-gradient(135deg, #f4f9f4 0%, #e8f5e9 100%); min-height: 100vh; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .header h1 { color: #2c7a2c; display: flex; align-items: center; gap: 10px; font-size: 1.8rem; }
    .controls { display: flex; gap: 15px; align-items: center; }
    .lang-select { padding: 10px 15px; border-radius: 8px; border: 2px solid #e1e5e9; background: white; font-size: 1rem; cursor: pointer; transition: border-color 0.3s; }
    .lang-select:focus { outline: none; border-color: #4caf50; }
    .add-btn { background: linear-gradient(135deg, #4caf50, #2c7a2c); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
    .add-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
    table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #e0e0e0; padding: 15px 12px; text-align: left; vertical-align: top; }
    th { background: linear-gradient(135deg, #2c7a2c, #4caf50); color: white; font-weight: 600; font-size: 0.9rem; }
    tr:nth-child(even) { background: #f8f9fa; } tr:hover { background: #e8f5e9; }
    button { padding: 8px 12px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; display: inline-flex; align-items: center; gap: 4px; }
    .edit-btn { background: #ff9800; color: white; } .edit-btn:hover { background: #f57c00; transform: translateY(-1px); }
    .save-btn { background: #2196f3; color: white; } .save-btn:hover { background: #1976d2; transform: translateY(-1px); }
    .delete-btn { background: #f44336; color: white; } .delete-btn:hover { background: #d32f2f; transform: translateY(-1px); }
    .cancel-btn { background: #9e9e9e; color: white; } .cancel-btn:hover { background: #757575; transform: translateY(-1px); }
    textarea, input { width: 100%; padding: 8px 10px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 0.9rem; font-family: inherit; transition: border-color 0.3s; }
    textarea:focus, input:focus { outline: none; border-color: #4caf50; box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1); }
    textarea { min-height: 60px; resize: vertical; }
    .multiline { white-space: pre-wrap; line-height: 1.4; }
    .actions { display: flex; gap: 5px; flex-wrap: wrap; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: 600; z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease; }
    .notification.show { transform: translateX(0); }
    .notification.success { background: #4caf50; } .notification.error { background: #f44336; }
    .loading { opacity: 0.6; pointer-events: none; }
    @media (max-width: 1200px) { .table-container { overflow-x: auto; } table { min-width: 1000px; } }
    @media (max-width: 768px) { .header { flex-direction: column; gap: 15px; align-items: stretch; } .controls { justify-content: space-between; } }
  </style>
</head>
<body>
<div class="header">
  <h1><i class="fas fa-robot"></i> AgroBot Admin Dashboard</h1>
  <div class="controls">
    <select id="languageSelect" class="lang-select" onchange="changeLanguage()">
      <option value="en">English</option>
      <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
      <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
    </select>
    <button class="add-btn" onclick="showAddRow()" id="addBtn"><i class="fas fa-plus"></i> <span id="addBtnText">Add New Entry</span></button>
  </div>
</div>

<div class="table-container">
  <table>
    <thead><tr id="tableHeader"></tr></thead>
    <tbody id="dataTable"></tbody>
  </table>
</div>

<div id="notification" class="notification"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
let userLanguage = 'en';
let knowledgeBase = [];
let originalKnowledgeBase = []; // Store original English data

const translations = {
  en: { 
    headers: ['Crop', 'Symptom', 'Possible Issue', 'Severity', 'Season', 'Prevention', 'Treatment', 'Organic Treatment', 'Actions'],
    addBtn: 'Add New Entry', edit: 'Edit', save: 'Save', cancel: 'Cancel', delete: 'Delete',
    confirmDelete: 'Are you sure you want to delete this entry?',
    successAdd: '‚úÖ Entry added successfully!', successUpdate: '‚úÖ Entry updated successfully!', successDelete: 'üóëÔ∏è Entry deleted successfully!',
    error: '‚ùå Operation failed. Please try again.', noEntries: 'No entries found. Click "Add New Entry" to create one.',
    loading: 'Translating data...'
  },
  hi: { 
    headers: ['‡§´‡§∏‡§≤', '‡§≤‡§ï‡•ç‡§∑‡§£', '‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ', '‡§ó‡§Ç‡§≠‡•Ä‡§∞‡§§‡§æ', '‡§Æ‡•å‡§∏‡§Æ', '‡§∞‡•ã‡§ï‡§•‡§æ‡§Æ', '‡§â‡§™‡§ö‡§æ‡§∞', '‡§∏‡§Ç‡§ó‡§†‡§ø‡§§ ‡§â‡§™‡§ö‡§æ‡§∞', '‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ‡§è‡§Å'],
    addBtn: '‡§®‡§à ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§ú‡•ã‡§°‡§º‡•á‡§Ç', edit: '‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç', save: '‡§∏‡§π‡•á‡§ú‡•á‡§Ç', cancel: '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç', delete: '‡§π‡§ü‡§æ‡§è‡§Å',
    confirmDelete: '‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?',
    successAdd: '‚úÖ ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§ú‡•ã‡§°‡§º‡•Ä ‡§ó‡§à!', successUpdate: '‚úÖ ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡•Ä ‡§ó‡§à!', successDelete: 'üóëÔ∏è ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§π‡§ü‡§æ‡§à ‡§ó‡§à!',
    error: '‚ùå ‡§ë‡§™‡§∞‡•á‡§∂‡§® ‡§µ‡§ø‡§´‡§≤‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§', noEntries: '‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä‡•§ ‡§®‡§à ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§¨‡§®‡§æ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è "‡§®‡§à ‡§™‡•ç‡§∞‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø ‡§ú‡•ã‡§°‡§º‡•á‡§Ç" ‡§™‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç‡•§',
    loading: '‡§°‡•á‡§ü‡§æ ‡§Ö‡§®‡•Å‡§µ‡§æ‡§¶‡§ø‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ú‡§æ ‡§∞‡§π‡§æ ‡§π‡•à...'
  },
  te: { 
    headers: ['‡∞™‡∞Ç‡∞ü', '‡∞≤‡∞ï‡±ç‡∞∑‡∞£‡∞Ç', '‡∞∏‡∞Ç‡∞≠‡∞æ‡∞µ‡±ç‡∞Ø ‡∞∏‡∞Æ‡∞∏‡±ç‡∞Ø', '‡∞§‡±Ä‡∞ï‡±ç‡∞∑‡±ç‡∞£‡∞§', '‡∞∏‡±Ä‡∞ú‡∞®‡±ç', '‡∞®‡∞ø‡∞∞‡±ã‡∞ß‡∞ï‡∞§', '‡∞ö‡∞ø‡∞ï‡∞ø‡∞§‡±ç‡∞∏', '‡∞∏‡±á‡∞Ç‡∞¶‡±ç‡∞∞‡±Ä‡∞Ø ‡∞ö‡∞ø‡∞ï‡∞ø‡∞§‡±ç‡∞∏', '‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø‡∞≤‡±Å'],
    addBtn: '‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø', edit: '‡∞∏‡∞Ç‡∞™‡∞æ‡∞¶‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø', save: '‡∞∏‡±á‡∞µ‡±ç', cancel: '‡∞∞‡∞¶‡±ç‡∞¶‡±Å', delete: '‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø',
    confirmDelete: '‡∞à ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä‡∞®‡∞ø ‡∞®‡∞ø‡∞ú‡∞Ç‡∞ó‡∞æ ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞æ‡∞≤‡∞æ?',
    successAdd: '‚úÖ ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä ‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!', successUpdate: '‚úÖ ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä ‡∞µ‡∞ø‡∞ú‡∞Ø‡∞µ‡∞Ç‡∞§‡∞Ç‡∞ó‡∞æ ‡∞®‡∞µ‡±Ä‡∞ï‡∞∞‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!', successDelete: 'üóëÔ∏è ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä‡∞®‡∞ø ‡∞§‡±ä‡∞≤‡∞ó‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø!',
    error: '‚ùå ‡∞Ü‡∞™‡∞∞‡±á‡∞∑‡∞®‡±ç ‡∞µ‡∞ø‡∞´‡∞≤‡∞Æ‡±à‡∞Ç‡∞¶‡∞ø. ‡∞¶‡∞Ø‡∞ö‡±á‡∞∏‡∞ø ‡∞Æ‡∞≥‡±ç‡∞≥‡±Ä ‡∞™‡±ç‡∞∞‡∞Ø‡∞§‡±ç‡∞®‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø.', noEntries: '‡∞è ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä‡∞≤‡±Å ‡∞≤‡±á‡∞µ‡±Å. ‡∞í‡∞ï ‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä ‡∞∏‡±É‡∞∑‡±ç‡∞ü‡∞ø‡∞Ç‡∞ö‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø "‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø" ‡∞ï‡±ç‡∞≤‡∞ø‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø‡•§',
    loading: '‡∞°‡±á‡∞ü‡∞æ ‡∞Ö‡∞®‡±Å‡∞µ‡∞¶‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡±Å‡∞§‡±ã‡∞Ç‡∞¶‡∞ø...'
  }
};

// Language codes mapping
const languageCodes = {
  'en': 'en',
  'hi': 'hi', 
  'te': 'te'
};

function showNotification(msg, type = 'success') {
  const n = document.getElementById('notification'); 
  n.textContent = msg; 
  n.className = `notification ${type} show`;
  setTimeout(() => n.classList.remove('show'), 4000);
}

async function loadKB() {
  try { 
    const res = await fetch('/admin/data');
    if (!res.ok) throw new Error('Failed to fetch data');
    originalKnowledgeBase = await res.json();
    knowledgeBase = [...originalKnowledgeBase]; // Create a copy
    renderTable(); 
  } catch(e) { 
    console.error('Error loading KB:', e);
    showNotification(translations[userLanguage].error, 'error'); 
  }
}

// Translate text using backend
async function translateText(text, targetLang) {
  if (!text || targetLang === 'en') return text;
  
  try {
    const response = await fetch('/translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        text: text,
        target_lang: targetLang
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      return data.translated_text || text;
    }
    return text;
  } catch (error) {
    console.error('Translation error:', error);
    return text;
  }
}

// Translate entire knowledge base
async function translateKnowledgeBase(targetLang) {
  if (targetLang === 'en') {
    knowledgeBase = [...originalKnowledgeBase];
    return;
  }

  showNotification(translations[userLanguage].loading, 'success');
  document.body.classList.add('loading');

  try {
    const translatedKB = [];
    
    for (const entry of originalKnowledgeBase) {
      const translatedEntry = {
        crop: await translateText(entry.crop, targetLang),
        symptom: await translateText(entry.symptom, targetLang),
        possible_issue: await translateText(entry.possible_issue, targetLang),
        severity: await translateText(entry.severity, targetLang),
        season: await translateText(entry.season, targetLang),
        prevention: await translateText(entry.prevention, targetLang),
        treatment: await translateText(entry.treatment, targetLang),
        organic_treatment: await translateText(entry.organic_treatment, targetLang)
      };
      translatedKB.push(translatedEntry);
    }
    
    knowledgeBase = translatedKB;
  } catch (error) {
    console.error('Error translating knowledge base:', error);
    knowledgeBase = [...originalKnowledgeBase]; // Fallback to English
  } finally {
    document.body.classList.remove('loading');
  }
}

async function addEntryToServer(newEntry) {
  try {
    const res = await fetch('/admin/data', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(newEntry)
    });
    if (!res.ok) throw new Error('Failed to add entry');
    const result = await res.json();
    
    // Add to both original and current KB
    originalKnowledgeBase.unshift(newEntry);
    if (userLanguage === 'en') {
      knowledgeBase.unshift(newEntry);
    } else {
      // Translate the new entry and add to current KB
      const translatedEntry = {
        crop: await translateText(newEntry.crop, userLanguage),
        symptom: await translateText(newEntry.symptom, userLanguage),
        possible_issue: await translateText(newEntry.possible_issue, userLanguage),
        severity: await translateText(newEntry.severity, userLanguage),
        season: await translateText(newEntry.season, userLanguage),
        prevention: await translateText(newEntry.prevention, userLanguage),
        treatment: await translateText(newEntry.treatment, userLanguage),
        organic_treatment: await translateText(newEntry.organic_treatment, userLanguage)
      };
      knowledgeBase.unshift(translatedEntry);
    }
    
    return result;
  } catch(e) {
    console.error('Error adding entry:', e);
    throw e;
  }
}

async function updateEntryOnServer(index, updatedEntry) {
  try {
    const res = await fetch('/admin/data', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ index, ...updatedEntry })
    });
    if (!res.ok) throw new Error('Failed to update entry');
    const result = await res.json();
    
    // Update both original and current KB
    originalKnowledgeBase[index] = updatedEntry;
    if (userLanguage === 'en') {
      knowledgeBase[index] = updatedEntry;
    } else {
      // Translate the updated entry
      const translatedEntry = {
        crop: await translateText(updatedEntry.crop, userLanguage),
        symptom: await translateText(updatedEntry.symptom, userLanguage),
        possible_issue: await translateText(updatedEntry.possible_issue, userLanguage),
        severity: await translateText(updatedEntry.severity, userLanguage),
        season: await translateText(updatedEntry.season, userLanguage),
        prevention: await translateText(updatedEntry.prevention, userLanguage),
        treatment: await translateText(updatedEntry.treatment, userLanguage),
        organic_treatment: await translateText(updatedEntry.organic_treatment, userLanguage)
      };
      knowledgeBase[index] = translatedEntry;
    }
    
    return result;
  } catch(e) {
    console.error('Error updating entry:', e);
    throw e;
  }
}

async function deleteEntryFromServer(index) {
  try {
    const res = await fetch('/admin/data', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ index })
    });
    if (!res.ok) throw new Error('Failed to delete entry');
    const result = await res.json();
    
    // Remove from both original and current KB
    originalKnowledgeBase.splice(index, 1);
    knowledgeBase.splice(index, 1);
    
    return result;
  } catch(e) {
    console.error('Error deleting entry:', e);
    throw e;
  }
}

async function changeLanguage() {
  userLanguage = document.getElementById('languageSelect').value;
  const t = translations[userLanguage];
  
  // Update UI text
  document.getElementById('addBtnText').textContent = t.addBtn;
  document.getElementById('tableHeader').innerHTML = t.headers.map(h => `<th>${h}</th>`).join('');
  
  // Translate knowledge base data
  await translateKnowledgeBase(userLanguage);
  renderTable();
}

function renderTable() {
  const table = document.getElementById('dataTable'); 
  const t = translations[userLanguage]; 
  table.innerHTML = '';
  
  if (knowledgeBase.length === 0) { 
    table.innerHTML = `<tr><td colspan="${t.headers.length}" style="text-align:center;padding:40px;color:#666;">${t.noEntries}</td></tr>`; 
    return; 
  }
  
  knowledgeBase.forEach((row, i) => {
    const tr = document.createElement('tr'); 
    tr.id = `row-${i}`;
    tr.innerHTML = `
      <td>${row.crop || ''}</td>
      <td class="multiline">${row.symptom || ''}</td>
      <td>${row.possible_issue || ''}</td>
      <td>${row.severity || ''}</td>
      <td>${row.season || ''}</td>
      <td class="multiline">${row.prevention || ''}</td>
      <td class="multiline">${row.treatment || ''}</td>
      <td class="multiline">${row.organic_treatment || ''}</td>
      <td>
        <div class="actions">
          <button class="edit-btn" onclick="editRow(${i})">
            <i class="fas fa-edit"></i> ${t.edit}
          </button>
          <button class="delete-btn" onclick="deleteRow(${i})">
            <i class="fas fa-trash"></i> ${t.delete}
          </button>
        </div>
      </td>`;
    table.appendChild(tr);
  });
}

function editRow(i) {
  // When editing, show the original English data for accurate editing
  const originalRow = originalKnowledgeBase[i];
  const tr = document.getElementById(`row-${i}`); 
  const t = translations[userLanguage];
  
  const editHTML = `
    <td><input value="${originalRow.crop || ''}"></td>
    <td><textarea>${originalRow.symptom || ''}</textarea></td>
    <td><input value="${originalRow.possible_issue || ''}"></td>
    <td><input value="${originalRow.severity || ''}"></td>
    <td><input value="${originalRow.season || ''}"></td>
    <td><textarea>${originalRow.prevention || ''}</textarea></td>
    <td><textarea>${originalRow.treatment || ''}</textarea></td>
    <td><textarea>${originalRow.organic_treatment || ''}</textarea></td>
    <td>
      <div class="actions">
        <button class="save-btn" onclick="saveRow(${i})">
          <i class="fas fa-save"></i> ${t.save}
        </button>
        <button class="cancel-btn" onclick="cancelEdit(${i})">
          <i class="fas fa-times"></i> ${t.cancel}
        </button>
      </div>
    </td>`;
  
  tr.innerHTML = editHTML;
}

function cancelEdit(i) {
  renderTable();
}

async function saveRow(i) {
  const tr = document.getElementById(`row-${i}`); 
  const inputs = tr.querySelectorAll('input, textarea'); 
  const vals = Array.from(inputs).map(el => el.value.trim());
  
  const updatedEntry = {
    crop: vals[0],
    symptom: vals[1],
    possible_issue: vals[2],
    severity: vals[3],
    season: vals[4],
    prevention: vals[5],
    treatment: vals[6],
    organic_treatment: vals[7]
  };
  
  try {
    await updateEntryOnServer(i, updatedEntry);
    showNotification(translations[userLanguage].successUpdate);
    renderTable();
  } catch(e) {
    showNotification(translations[userLanguage].error, 'error');
  }
}

async function deleteRow(i) {
  const t = translations[userLanguage]; 
  if (!confirm(t.confirmDelete)) return;
  
  try {
    await deleteEntryFromServer(i);
    showNotification(t.successDelete);
    renderTable();
  } catch(e) {
    showNotification(t.error, 'error');
  }
}

function showAddRow() {
  const table = document.getElementById('dataTable'); 
  const newRow = document.getElementById('row-new'); 
  if (newRow) newRow.remove();
  
  const tr = document.createElement('tr'); 
  tr.id = 'row-new'; 
  tr.style.background = '#e8f5e9';
  const t = translations[userLanguage];
  
  tr.innerHTML = `
    <td><input id="crop-new"></td>
    <td><textarea id="symptom-new"></textarea></td>
    <td><input id="issue-new"></td>
    <td><input id="severity-new"></td>
    <td><input id="season-new"></td>
    <td><textarea id="prevention-new"></textarea></td>
    <td><textarea id="treatment-new"></textarea></td>
    <td><textarea id="organic-new"></textarea></td>
    <td>
      <div class="actions">
        <button class="save-btn" onclick="addEntry()">
          <i class="fas fa-plus"></i> ${t.addBtn}
        </button>
        <button class="cancel-btn" onclick="cancelAdd()">
          <i class="fas fa-times"></i> ${t.cancel}
        </button>
      </div>
    </td>`;
  table.prepend(tr);
}

function cancelAdd() { 
  const newRow = document.getElementById('row-new'); 
  if (newRow) newRow.remove(); 
}

async function addEntry() {
  const vals = ['crop', 'symptom', 'issue', 'severity', 'season', 'prevention', 'treatment', 'organic']
    .map(id => {
      const element = document.getElementById(`${id}-new`);
      return element ? element.value.trim() : '';
    });
  
  const [crop, symptom, possible_issue, severity, season, prevention, treatment, organic_treatment] = vals; 
  const t = translations[userLanguage];
  
  if (!crop || !symptom || !possible_issue) { 
    showNotification('Please fill in at least Crop, Symptom, and Possible Issue fields.', 'error'); 
    return; 
  }
  
  const newEntry = { crop, symptom, possible_issue, severity, season, prevention, treatment, organic_treatment };
  
  try {
    await addEntryToServer(newEntry);
    showNotification(t.successAdd);
    cancelAdd();
    renderTable();
  } catch(e) {
    showNotification(t.error, 'error');
  }
}

document.addEventListener('DOMContentLoaded', () => {
  changeLanguage();
  loadKB();
});
</script>
</body>
</html>