<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AgroBot Admin Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f9f4; }
    h2 { color: #2c7a2c; display: inline-block; margin-right: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #2c7a2c; color: white; }
    button { padding: 6px 10px; margin: 2px; border: none; border-radius: 6px; cursor: pointer; }
    .add-btn { background: #4caf50; color: white; }
    .delete-btn { background: #f44336; color: white; }
    .save-btn { background: #2196f3; color: white; }
    .edit-btn { background: #ff9800; color: white; }
    .lang-select { padding: 6px 10px; border-radius: 6px; border: 1px solid #ccc; margin-left: 10px; }
    textarea { width: 100%; min-height: 50px; }
  </style>
</head>
<body>
<h2>üå± AgroBot Admin Dashboard</h2>
<select id="languageSelect" class="lang-select" onchange="changeLanguage()">
  <option value="en">English</option>
  <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
  <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å</option>
</select>
<button class="add-btn" onclick="showAddRow()" id="addBtn">‚ûï Add New Entry</button>

<table>
  <thead>
    <tr id="tableHeader"></tr>
  </thead>
  <tbody id="dataTable"></tbody>
</table>

<script>
let userLanguage = 'en';
let translations = {
  en: { headers: ['Crop','Symptom','Possible Issue','Severity','Season','Prevention','Treatment','Organic Treatment','Actions'], addBtn: '‚ûï Add New Entry' },
  hi: { headers: ['‡§´‡§∏‡§≤','‡§≤‡§ï‡•ç‡§∑‡§£','‡§∏‡§Ç‡§≠‡§æ‡§µ‡§ø‡§§ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ','‡§§‡•Ä‡§µ‡•ç‡§∞‡§§‡§æ','‡§Æ‡•å‡§∏‡§Æ‡•Ä ‡§Ö‡§µ‡§ß‡§ø','‡§∞‡•ã‡§ï‡§•‡§æ‡§Æ','‡§â‡§™‡§ö‡§æ‡§∞','‡§∏‡§Ç‡§ó‡•ç‡§∞‡§π‡§ø‡§§ ‡§â‡§™‡§ö‡§æ‡§∞','‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ‡§è‡§Å'], addBtn: '‚ûï ‡§®‡§Ø‡§æ ‡§è‡§Ç‡§ü‡•ç‡§∞‡•Ä ‡§ú‡•ã‡§°‡§º‡•á‡§Ç' },
  te: { headers: ['‡∞™‡∞Ç‡∞ü','‡∞≤‡∞ï‡±ç‡∞∑‡∞£‡∞Ç','‡∞∏‡∞æ‡∞ß‡±ç‡∞Ø‡∞Æ‡±à‡∞® ‡∞∏‡∞Æ‡∞∏‡±ç‡∞Ø','‡∞§‡±Ä‡∞µ‡±ç‡∞∞‡∞§','‡∞∏‡±Ä‡∞ú‡∞®‡±ç','‡∞®‡∞ø‡∞µ‡∞æ‡∞∞‡∞£','‡∞ö‡∞ø‡∞ï‡∞ø‡∞§‡±ç‡∞∏','‡∞∏‡±á‡∞Ç‡∞¶‡±ç‡∞∞‡±Ä‡∞ï‡±É‡∞§ ‡∞ö‡∞ø‡∞ï‡∞ø‡∞§‡±ç‡∞∏','‡∞ï‡±ç‡∞∞‡∞ø‡∞Ø‡∞≤‡±Å'], addBtn: '‚ûï ‡∞ï‡±ä‡∞§‡±ç‡∞§ ‡∞é‡∞Ç‡∞ü‡±ç‡∞∞‡±Ä ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞Ç‡∞°‡∞ø' }
};

// Change language
async function changeLanguage() {
  userLanguage = document.getElementById('languageSelect').value;
  const headerRow = document.getElementById('tableHeader');
  headerRow.innerHTML = translations[userLanguage].headers.map(h => `<th>${h}</th>`).join('');
  document.getElementById('addBtn').textContent = translations[userLanguage].addBtn;
  await loadData();
}

// Load table data
async function loadData() {
  try {
    const res = await fetch('/admin/data');
    const data = await res.json();
    const table = document.getElementById('dataTable');
    table.innerHTML = '';
    for(let i=0;i<data.length;i++){
      renderRow(data[i], i);
    }
  } catch(e){ console.error(e); }
}

// Render one row
async function renderRow(row, i){
  let fields = [
    row.crop || '', row.symptom || '', row.possible_issue || '', row.severity || '',
    row.season || '', row.prevention || '', row.treatment || '', row.organic_treatment || ''
  ];
  if(userLanguage !== 'en'){
    fields = await Promise.all(fields.map(f => f ? translateText(f) : ''));
  }
  const table = document.getElementById('dataTable');
  table.innerHTML += `<tr id="row-${i}">
    <td class="view-mode">${fields[0]}</td>
    <td class="view-mode multiline">${fields[1]}</td>
    <td class="view-mode">${fields[2]}</td>
    <td class="view-mode">${fields[3]}</td>
    <td class="view-mode">${fields[4]}</td>
    <td class="view-mode multiline">${fields[5]}</td>
    <td class="view-mode multiline">${fields[6]}</td>
    <td class="view-mode multiline">${fields[7]}</td>
    <td>
      <button class="edit-btn" onclick="editRow(${i})">Edit</button>
      <button class="save-btn" onclick="saveRow(${i})" style="display:none;">Save</button>
      <button class="delete-btn" onclick="deleteRow(${i})">Delete</button>
    </td>
  </tr>`;
}

// Translate text
async function translateText(text){
  try{
    const res = await fetch('/translate_text',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text:text, lang:userLanguage})
    });
    const data = await res.json();
    return data.translated || text;
  }catch(e){ return text; }
}

// Translate to English
async function translateToEnglish(text){
  if(!text) return '';
  try{
    const res = await fetch('/translate_text',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text:text, lang:'en'})
    });
    const data = await res.json();
    return data.translated || text;
  } catch(e){ return text; }
}

// Edit row
function editRow(i){
  const row = document.getElementById(`row-${i}`);
  const tds = row.querySelectorAll('td');
  tds.forEach(td=>{
    if(td.classList.contains('view-mode')){
      const val = td.innerText;
      td.innerHTML = td.classList.contains('multiline') ? `<textarea>${val}</textarea>` : `<input type="text" value="${val}">`;
    }
  });
  row.querySelector('.edit-btn').style.display='none';
  row.querySelector('.save-btn').style.display='inline-block';
}

// Save row
async function saveRow(i){
  const row = document.getElementById(`row-${i}`);
  const tds = row.querySelectorAll('td');
  const values = Array.from(tds)
    .filter(td=>td.querySelector('input') || td.querySelector('textarea'))
    .map(td => (td.querySelector('input')?.value || td.querySelector('textarea')?.value).trim());

  const [crop,symptom,possible_issue,severity,season,prevention,treatment,organic] = await Promise.all(
    values.map(v => v ? translateToEnglish(v) : '')
  );

  const res = await fetch('/admin/update/'+i,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({crop,symptom,possible_issue,severity,season,prevention,treatment,organic_treatment:organic})
  });
  const result = await res.json();
  if(result.status === "success"){
    alert("‚úÖ Entry updated successfully!");
    await loadData();
  } else {
    alert("‚ùå Failed to update entry.");
  }
}

// Delete row
async function deleteRow(i){
  if(!confirm("Are you sure you want to delete this entry?")) return;
  const res = await fetch('/admin/delete/'+i,{method:'DELETE'});
  const result = await res.json();
  if(result.status === "success"){
    alert("üóëÔ∏è Entry deleted successfully!");
    await loadData();
  } else {
    alert("‚ùå Failed to delete entry.");
  }
}

// Show add row
function showAddRow(){
  const table = document.getElementById('dataTable');
  if(document.getElementById("row-new")) return; // prevent multiple
  const row = `<tr id="row-new">
    <td><input type="text" id="crop-new"></td>
    <td><textarea id="symptom-new"></textarea></td>
    <td><input type="text" id="issue-new"></td>
    <td><input type="text" id="severity-new"></td>
    <td><input type="text" id="season-new"></td>
    <td><textarea id="prevention-new"></textarea></td>
    <td><textarea id="treatment-new"></textarea></td>
    <td><textarea id="organic-new"></textarea></td>
    <td><button class="save-btn" onclick="addEntry()">Add</button></td>
  </tr>`;
  table.insertAdjacentHTML("afterbegin", row);
}

// Add new entry
async function addEntry(){
  const fields = ['crop','symptom','issue','severity','season','prevention','treatment','organic'].map(id => document.getElementById(`${id}-new`).value.trim());
  const [crop,symptom,possible_issue,severity,season,prevention,treatment,organic] = await Promise.all(fields.map(f => f ? translateToEnglish(f) : ''));

  const res = await fetch('/admin/add',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({crop,symptom,possible_issue,severity,season,prevention,treatment,organic_treatment:organic})
  });
  const result = await res.json();

  if(result.status === "success"){
    alert("‚úÖ Entry added successfully!");
    document.getElementById("row-new").remove();
    renderRow({crop,symptom,possible_issue,severity,season,prevention,treatment,organic_treatment:organic}, document.querySelectorAll("#dataTable tr").length);
  } else {
    alert("‚ùå Failed to add entry.");
  }
}

changeLanguage();
</script>
</body>
</html>
